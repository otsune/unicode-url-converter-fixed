# Unicode URL Converter 仕様書 & TODO

## 概要

本拡張機能は、Webページ内の指定された要素に含まれる特殊なUnicode文字（例: ˸, ․, ⁄）を、通常の記号（:、.、/ など）に変換するChrome拡張機能です。

---

## 現状仕様

### 基本機能
- 対象: Webページ内の指定されたタグのテキスト（デフォルト: `<p>`タグ）
- 変換対象文字:
    - ˸ (U+02F8) → :
    - ․ (U+2024) → .
    - ⁄ (U+2044) → /
- 変換はポップアップから「テキストを変換」ボタンで実行
- 変換結果はポップアップに件数付きで表示

### 変換対象文字のカスタマイズ
- ポップアップ画面で変換対象文字の追加・編集・削除が可能
- 変換マップはchrome.storage.localに保存され、次回以降も反映
- 追加時はUnicode文字と変換後文字を1文字ずつ指定
- ドラッグ&ドロップで変換リストの並び替えが可能

### 変換対象タグのカスタマイズ
- 変換対象のHTMLタグをカスタマイズ可能（デフォルト: p）
- 複数のタグをカンマ区切りで指定可能（例: p, div, span）

### 設定のインポート・エクスポート
- 変換マップのJSON形式でのエクスポート機能
- エクスポートした設定ファイルのインポート機能
- バリデーション機能付き

### 変換履歴
- 変換実行時の履歴を保存
- 履歴にはURL、変換文字数、実行日時を含む
- 最新50件まで保存
- 履歴の一括削除機能

### 多言語対応
- 日本語・英語の完全対応
- UIテキスト、エラーメッセージ、コンソールメッセージの多言語化
- ブラウザの言語設定に応じた自動切り替え

### エラーハンドリング
- Content scriptとの通信エラーの詳細なハンドリング
- リトライ機能付きの通信確立
- Chrome内部ページでの動作制限
- ファイルURLでの動作制限

### 技術仕様
- Manifest V3対応
- ES6モジュール対応（popup.js）
- 通常スクリプト対応（content.js）
- Jestによるユニットテスト実装
- chrome.storage.localによる設定保存
- chrome.scripting APIによる動的スクリプト注入

---

## 完了したTODO

✅ **UI改善**
- 変換対象リストの並び替え機能（ドラッグ&ドロップ）
- 変換対象の説明やUnicodeコードポイント表示の強化
- 編集時のバリデーション強化（1文字制限や重複チェック）

✅ **機能拡張**
- 変換対象の一括インポート・エクスポート機能
- 変換履歴の保存・表示
- 変換対象タグのカスタマイズ（p以外も選択可能に）

✅ **ユーザビリティ**
- 設定のリセット（デフォルトに戻す）ボタン
- 多言語対応（日本語・英語切替）

✅ **技術的改善**
- ユニットテスト・自動テストの導入
- コードのリファクタリングとモジュール分割

---

## 🚨 リファクタリング TODO（優先度順）

### **優先度1（緊急）：セキュリティ・パフォーマンス修正**

#### 🛡️ **セキュリティ脆弱性の修正**
- [ ] **XSS脆弱性修正** (ui.js:114行)
  - `innerHTML` → `createElement/textContent` に変更
  - ユーザー入力データのサニタイゼーション強化
  - 影響範囲：renderConversionList関数

- [ ] **URL検証強化** (popup.js:99-108行)
  - ブラックリスト方式からホワイトリスト方式へ変更
  - 新プロトコルスキーム対応
  - 影響範囲：convertBtn イベントハンドラー

- [ ] **権限最小化** (manifest.json)
  - `<all_urls>` 権限の見直し
  - 動的権限要求の検討
  - 影響範囲：manifest.json content_scripts

#### ⚡ **パフォーマンス最適化**
- [ ] **DOM操作最適化** (ui.js:101-122行)
  - `innerHTML = ''` → `replaceChildren()` に変更
  - DocumentFragment使用によるバッチ更新
  - 影響範囲：renderConversionList, renderHistory

- [ ] **メモリリーク対策** (popup.js:92-149行)
  - イベントリスナーの適切な削除
  - setTimeout の管理改善
  - 影響範囲：全体的なイベント処理

### **優先度2（高）：アーキテクチャ改善**

#### 🏗️ **レイヤードアーキテクチャ導入**
- [ ] **Controllers レイヤー作成**
  - `PopupController` クラスの作成
  - `ConversionController` クラスの作成
  - 影響範囲：popup.js 全体

- [ ] **Services レイヤー作成**
  - `StorageService` クラスの作成
  - `MessageService` クラスの作成
  - `HistoryService` クラスの作成
  - 影響範囲：storage.js, popup.js

- [ ] **依存関係注入の導入**
  - `DependencyContainer` の作成
  - インターフェース定義
  - 影響範囲：全モジュール

#### 🔧 **長大関数の分割**
- [ ] **ensureContentScript関数の分割** (popup.js:48-88行)
  - `ContentScriptManager` クラスに分割
  - `RetryPolicy` の抽象化
  - `ConnectionValidator` の分離
  - 影響範囲：popup.js 通信処理

- [ ] **convertBtn ハンドラーの分割** (popup.js:92-149行)
  - `URLValidator` の分離
  - `ConversionExecutor` の分離
  - `HistoryManager` の分離
  - 影響範囲：popup.js イベント処理

### **優先度3（中）：コード品質改善**

#### 🔄 **重複コード削除**
- [ ] **isChromeAPI関数の統一**
  - 共通ユーティリティモジュール作成
  - 影響範囲：storage.js, ui.js, content.js

- [ ] **createUnicodePattern関数の統一**
  - utils.js への統一
  - content.js からの重複削除
  - 影響範囲：content.js, utils.js

- [ ] **エラーハンドリングの統一**
  - `ErrorHandler` クラスの作成
  - 統一エラーメッセージ形式
  - 影響範囲：全モジュール

#### 🧪 **テスト可能性の向上**
- [ ] **Chrome APIs のモッキング対応**
  - `ChromeAPIWrapper` の作成
  - テスト用モック実装
  - 影響範囲：popup.js, storage.js

- [ ] **DOM操作の抽象化**
  - `DOMManager` クラスの作成
  - テスト用DOM操作モック
  - 影響範囲：ui.js, popup.js

### **優先度4（低）：品質向上**

#### 📊 **ログ・デバッグ改善**
- [ ] **本番環境ログの削除**
  - console.log の条件分岐化
  - 開発/本番環境の分離
  - 影響範囲：全ファイル

- [ ] **エラーログの構造化**
  - ログレベルの導入
  - 構造化ログ形式
  - 影響範囲：全モジュール

#### 🔍 **コードメトリクス改善**
- [ ] **複雑度削減**
  - 関数複雑度 < 10 の達成
  - 関数行数 < 30行 の達成
  - 影響範囲：全関数

- [ ] **依存関係の可視化**
  - 依存関係グラフの作成
  - 循環依存の検出・解決
  - 影響範囲：モジュール間関係

---

## 実装フェーズ計画

### **フェーズ1（1-2週間）：緊急対応**
1. XSS脆弱性修正 (ui.js)
2. DOM操作最適化 (ui.js)  
3. 本番ログ削除 (全ファイル)
4. 権限最小化 (manifest.json)

### **フェーズ2（2-3週間）：構造改善**
1. Controllers レイヤー作成
2. Services レイヤー作成
3. 依存関係注入導入
4. 長大関数の分割

### **フェーズ3（2-3週間）：品質向上**
1. 重複コード削除
2. エラーハンドリング統一
3. テスト可能性向上
4. コードメトリクス改善

### **フェーズ4（1-2週間）：完成**
1. 最終テスト実行
2. ドキュメント更新
3. パフォーマンス検証
4. セキュリティ監査

---

## 成功指標

### **品質指標**
- 関数複雑度 < 10
- 関数行数 < 30行
- ファイル行数 < 200行
- セキュリティ脆弱性 0件

### **パフォーマンス指標**  
- ポップアップ表示 < 100ms
- 変換処理 < 50ms
- メモリ使用量 < 10MB
- DOM操作 50% 速度向上

### **テスト指標**
- 単体テスト > 80%
- 統合テスト > 60%  
- E2Eテスト > 40%

---

## 今後の新機能提案

### 追加機能
1. **変換プリセット機能**
   - よく使う変換設定のプリセット保存・読み込み
   - プリセットの共有機能

2. **高度な変換ルール**
   - 正規表現による複雑な変換パターン
   - 条件付き変換（特定の要素内のみ）

3. **アクセシビリティ向上**
   - キーボードショートカット対応
   - スクリーンリーダー対応

### 技術的改善
1. **テスト強化**
   - E2Eテストの追加
   - パフォーマンステストの実装

2. **CI/CD整備**
   - 自動テスト実行
   - 自動デプロイ

---

> 本仕様書およびTODOは2025年1月時点の内容です。リファクタリング分析により大幅な改善項目を追加しました。 